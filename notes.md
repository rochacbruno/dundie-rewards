# Password Hashing

## Start

```bash
export DUNDIE_EMAIL=
export DUNDIE_PASSWORD=
```

```bash
dundie add 500 --email=pam@dm.com
...
```


## 0 Ajustes
requirements.txt
```
setuptools
pwdlib[argon2]
```
`pip install -r requirements.txt`

`make test`

### 3 testes falhando

```
make test
```

Precisamos alterar a função de criação de usuário para receber um password
explicitamente.

`dundie/utils/db.py`
```py
def add_person(
    session: Session,
    instance: Person,
    password: str | None = None,
):
    """Saves person data to database.

    - If exists, update, else create
    - Set initial balance (managers = 100, others = 500)
    - Generate a password if user is new and send_email
    """
    existing = session.exec(
        select(Person).where(Person.email == instance.email)
    ).first()
    created = existing is None
    if created:
        session.add(instance)
        set_initial_balance(session, instance)
        password = set_initial_password(session, instance, password)
        # TODO: Usar sistema de filas (conteudo extra)
        send_email(
            EMAIL_FROM, [instance.email], "Your dundie password", password
        )
        return instance, created
    elif isinstance(existing, Person):
        existing.dept = instance.dept
        existing.role = instance.role
        existing.currency = instance.currency
        session.add(existing)
        return instance, created


def set_initial_password(
    session: Session,
    instance: Person,
    password: str | None = None,
) -> str:
    """Generated and saves password"""
    user = User(person=instance)  # password generated by model
    if password is not None:
        user.password = password
    else:
        password = user.password
    session.add(user)
    return password
```

`test_add.py`
```python
@pytest.fixture(scope="function", autouse=True)
def auth(monkeypatch):
    with get_session() as session, monkeypatch.context() as ctx:
        data = {
            "role": "Manager",
            "dept": "Management",
            "name": "Michael Scott",
            "email": "scott@dm.com",
        }
        password = "1234"
        person, _ = add_person(session, Person(**data), password)
        ctx.setenv("DUNDIE_EMAIL", person.email)
        ctx.setenv("DUNDIE_PASSWORD", password)
        session.commit()
        yield
```

O add está protegido por senha, mas a senha está salva em texto plano.

vamos resolver isso.

## 1 Setar Secret Key

```bash
❯ python -c 'import secrets; print(secrets.token_urlsafe(50))'
zx70WB2OhhzAMYD6VaDLZqpF3F77hOpDscExC8sIKx0RwZuok_KBg-L5RRyM4rN9VuU
```

`settings.py`
```py
SALT_KEY = (
    "zx70WB2OhhzAMYD6VaDLZqpF3F77hOpDscExC8sIKx0RwZuok_KBg-L5RRyM4rN9VuU"
)
```

# NOTE: unsafe to have it on repo.

## 2 Criar função para criar hash do password

```python
...
from pwdlib import PasswordHash
from ..settings import SECRET_KEY

pwd_context = PasswordHash.recommended()


...


def get_password_hash(password: str) -> str:
    return pwd_context.hash(password, salt=SECRET_KEY.encode())


def verify_password(plain_password: str, hashed_password: str) -> bool:
    return pwd_context.verify(plain_password, hashed_password)
```

## testar as funcoes de hashing

`test_utils.py`
```python
from dundie.utils.user import get_password_hash, verify_password

...

@pytest.mark.unit
def test_password_hash():
    password = "batatinha123"
    hashed = get_password_hash(password)
    assert hashed != password
    assert verify_password(password, hashed)
```
```bash
.venv/bin/pytest -s -k hash
```
> Print??

## Alterar `add_person` para salvar password com hash.

`utils/db.py`

```python
def set_initial_password(
    session: Session,
    instance: Person,
    password: str | None = None
) -> str:
    """Generates, hashes and saves password"""
    user = User(person=instance)  # password generated by model

    if password is not None:
        user.password = password
    else:
        password = user.password

    # save to database the password hashed
    user.password = get_password_hash(user.password)
    session.add(user)
    # return the plain password for email
    # NOTE: The recommendation is not to send passwords via e-mail
    # A future improvement is to send user a disposable link for first login.
    return password
```

## Run test

`make test`
```
            # TODO: in future we are going to encrypt.
            if person.user[0].password != password:
>               raise AuthError("Authentication Error")
E               dundie.utils.auth.AuthError: Authentication Error

/home/rochacbruno/Projects/dundie-rewards/dundie/utils/auth.py:41: AuthError

```

## Arrumar auth para comparar hashes

`dundie/utils/auth.py`

```python
if not verify_password(password, person.user[0].password):
    raise AuthError("Authentication Error")
```

## Problema: usuarios existentes

```
dundie add 500 --email=pam@dm.com
    raise exceptions.UnknownHashError(hash)
pwdlib.exceptions.UnknownHashError: This hash can't be identified. Make sure it's valid and that its corresponding hasher is enabled.
```

# Data migration hash users password

O hash começa com `$argon` portanto podemos distinguir senhas planas.

```python
alembic revision -m "hash_passwords"
  Generating /home/rochacbruno/Projects/dundie-rewards/migrations/versions/6bdf305b8029_hash_passwords.py ...  done
```

```python
"""hash_passwords

Revision ID: 6bdf305b8029
Revises: c4abb08ab5d3
Create Date: 2024-08-09 15:50:41.755091

"""
from alembic import op
import sqlalchemy as sa
import sqlmodel
from dundie.models import User
from dundie.utils.user import get_password_hash, verify_password
from sqlmodel import Session, select

# revision identifiers, used by Alembic.
revision = '6bdf305b8029'
down_revision = 'c4abb08ab5d3'
branch_labels = None
depends_on = None


def upgrade():
    bind = op.get_bind()
    session = Session(bind=bind)

    users = session.exec(select(User).where(~User.password.like("$argon%")))

    for user in users:
        plain = user.password
        hashed = get_password_hash(plain)
        if verify_password(plain, hashed):
            user.password = hashed
            session.add(user)

    session.commit()


def downgrade():
    pass
```

```python
alembic upgrade head
```

```console
❯ dundie add 500 --email=pam@dm.com
                                          Dunder Mifflin Report
┏━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━┳━━━━━━━━━━┓
┃ Email      ┃ Balance ┃ Last Movement       ┃ Dept    ┃ Role         ┃ Name       ┃ Currency ┃ Value    ┃
┡━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━╇━━━━━━━━━━┩
│ pam@dm.com │ 2400.00 │ 09/08/2024 16:04:36 │ General │ Receptionist │ Pam Beasly │ BRL      │ 13328.40 │
└────────────┴─────────┴─────────────────────┴─────────┴──────────────┴────────────┴──────────┴──────────┘
```
